# This is an experiment to try to achive an order of magnitude faster start times for topic configuration commands
# which we typically run as kubernetes jobs, over and over again

FROM curlimages/curl@sha256:533cc13b5e395fd9203d68496603ed94fd01af959605523c770446986f38c874 as maven-jars

RUN curl -o /slf4j-simple-1.7.28.jar http://central.maven.org/maven2/org/slf4j/slf4j-simple/1.7.28/slf4j-simple-1.7.28.jar
RUN curl -o /slf4j-nop-1.7.28.jar http://central.maven.org/maven2/org/slf4j/slf4j-nop/1.7.28/slf4j-nop-1.7.28.jar
# Does native-image support tweaks for kafka-client
RUN curl -o /quarkus-kafka-client-0.16.1.jar http://central.maven.org/maven2/io/quarkus/quarkus-kafka-client/0.16.1/quarkus-kafka-client-0.16.1.jar

# Built with a patch that eliminates some reflection: https://github.com/jopt-simple/jopt-simple/compare/jopt-simple-5.0.4...solsson:reflection-avoidance
FROM solsson/jar-jopt-simple:5.0.4-reflectless@sha256:39a9249826192b3e9a290028da151e81fdccb3e4308fda3b7403fb6a6d9b9f78 as jopt-simple-jar

FROM solsson/kafka@sha256:bc6aa2962c772733a07ed9ccbc48c8b218f8c42889c83e251665d193015a2a2f as dist

# The rest can be generated from:
#docker run --rm --entrypoint sleep --name kafkaimage -d [the FROM above] infinity
#docker exec -ti kafkaimage sed -i 's/exec/echo exec/' bin/kafka-run-class.sh
#docker exec -ti kafkaimage ./bin/kafka-topics.sh args-go-here | sed 's|/opt/kafka/bin/../libs/|./libs/|g'

COPY --from=maven-jars /slf4j-nop-1.7.28.jar /opt/kafka/libs/slf4j-nop-1.7.28.jar

#ENTRYPOINT [ "/opt/java/openjdk/bin/java", "-cp", "./libs/activation-1.1.1.jar:./libs/aopalliance-repackaged-2.5.0-b42.jar:./libs/argparse4j-0.7.0.jar:./libs/audience-annotations-0.5.0.jar:./libs/commons-lang3-3.8.1.jar:./libs/connect-api-2.2.1.jar:./libs/connect-basic-auth-extension-2.2.1.jar:./libs/connect-file-2.2.1.jar:./libs/connect-json-2.2.1.jar:./libs/connect-runtime-2.2.1.jar:./libs/connect-transforms-2.2.1.jar:./libs/guava-20.0.jar:./libs/hk2-api-2.5.0-b42.jar:./libs/hk2-locator-2.5.0-b42.jar:./libs/hk2-utils-2.5.0-b42.jar:./libs/jackson-annotations-2.9.8.jar:./libs/jackson-core-2.9.8.jar:./libs/jackson-databind-2.9.8.jar:./libs/jackson-datatype-jdk8-2.9.8.jar:./libs/jackson-jaxrs-base-2.9.8.jar:./libs/jackson-jaxrs-json-provider-2.9.8.jar:./libs/jackson-module-jaxb-annotations-2.9.8.jar:./libs/javassist-3.22.0-CR2.jar:./libs/javax.annotation-api-1.2.jar:./libs/javax.inject-1.jar:./libs/javax.inject-2.5.0-b42.jar:./libs/javax.servlet-api-3.1.0.jar:./libs/javax.ws.rs-api-2.1.1.jar:./libs/javax.ws.rs-api-2.1.jar:./libs/jaxb-api-2.3.0.jar:./libs/jersey-client-2.27.jar:./libs/jersey-common-2.27.jar:./libs/jersey-container-servlet-2.27.jar:./libs/jersey-container-servlet-core-2.27.jar:./libs/jersey-hk2-2.27.jar:./libs/jersey-media-jaxb-2.27.jar:./libs/jersey-server-2.27.jar:./libs/jetty-client-9.4.14.v20181114.jar:./libs/jetty-continuation-9.4.14.v20181114.jar:./libs/jetty-http-9.4.14.v20181114.jar:./libs/jetty-io-9.4.14.v20181114.jar:./libs/jetty-security-9.4.14.v20181114.jar:./libs/jetty-server-9.4.14.v20181114.jar:./libs/jetty-servlet-9.4.14.v20181114.jar:./libs/jetty-servlets-9.4.14.v20181114.jar:./libs/jetty-util-9.4.14.v20181114.jar:./libs/jopt-simple-5.0.4.jar:./libs/kafka_2.12-2.2.1.jar:./libs/kafka_2.12-2.2.1-sources.jar:./libs/kafka-clients-2.2.1.jar:./libs/kafka-log4j-appender-2.2.1.jar:./libs/kafka-streams-2.2.1.jar:./libs/kafka-streams-examples-2.2.1.jar:./libs/kafka-streams-scala_2.12-2.2.1.jar:./libs/kafka-streams-test-utils-2.2.1.jar:./libs/kafka-tools-2.2.1.jar:./libs/log4j-1.2.17.jar:./libs/lz4-java-1.5.0.jar:./libs/maven-artifact-3.6.0.jar:./libs/metrics-core-2.2.0.jar:./libs/osgi-resource-locator-1.0.1.jar:./libs/plexus-utils-3.1.0.jar:./libs/reflections-0.9.11.jar:./libs/rocksdbjni-5.15.10.jar:./libs/scala-library-2.12.8.jar:./libs/scala-logging_2.12-3.9.0.jar:./libs/scala-reflect-2.12.8.jar:./libs/slf4j-api-1.7.28.jar:./libs/slf4j-log4j12-1.7.28.jar:./libs/snappy-java-1.1.7.2.jar:./libs/validation-api-1.1.0.Final.jar:./libs/zkclient-0.11.jar:./libs/zookeeper-3.4.13.jar:./libs/zstd-jni-1.3.8-1.jar" ]
ENTRYPOINT [ "/opt/java/openjdk/bin/java", "-cp", "./libs/activation-1.1.1.jar:./libs/aopalliance-repackaged-2.5.0.jar:./libs/argparse4j-0.7.0.jar:./libs/audience-annotations-0.5.0.jar:./libs/commons-cli-1.4.jar:./libs/commons-lang3-3.8.1.jar:./libs/connect-api-2.4.0.jar:./libs/connect-basic-auth-extension-2.4.0.jar:./libs/connect-file-2.4.0.jar:./libs/connect-json-2.4.0.jar:./libs/connect-mirror-2.4.0.jar:./libs/connect-mirror-client-2.4.0.jar:./libs/connect-runtime-2.4.0.jar:./libs/connect-transforms-2.4.0.jar:./libs/guava-20.0.jar:./libs/hk2-api-2.5.0.jar:./libs/hk2-locator-2.5.0.jar:./libs/hk2-utils-2.5.0.jar:./libs/jackson-annotations-2.10.0.jar:./libs/jackson-core-2.10.0.jar:./libs/jackson-databind-2.10.0.jar:./libs/jackson-dataformat-csv-2.10.0.jar:./libs/jackson-datatype-jdk8-2.10.0.jar:./libs/jackson-jaxrs-base-2.10.0.jar:./libs/jackson-jaxrs-json-provider-2.10.0.jar:./libs/jackson-module-jaxb-annotations-2.10.0.jar:./libs/jackson-module-paranamer-2.10.0.jar:./libs/jackson-module-scala_2.12-2.10.0.jar:./libs/jakarta.activation-api-1.2.1.jar:./libs/jakarta.annotation-api-1.3.4.jar:./libs/jakarta.inject-2.5.0.jar:./libs/jakarta.ws.rs-api-2.1.5.jar:./libs/jakarta.xml.bind-api-2.3.2.jar:./libs/javassist-3.22.0-CR2.jar:./libs/javax.servlet-api-3.1.0.jar:./libs/javax.ws.rs-api-2.1.1.jar:./libs/jaxb-api-2.3.0.jar:./libs/jersey-client-2.28.jar:./libs/jersey-common-2.28.jar:./libs/jersey-container-servlet-2.28.jar:./libs/jersey-container-servlet-core-2.28.jar:./libs/jersey-hk2-2.28.jar:./libs/jersey-media-jaxb-2.28.jar:./libs/jersey-server-2.28.jar:./libs/jetty-client-9.4.20.v20190813.jar:./libs/jetty-continuation-9.4.20.v20190813.jar:./libs/jetty-http-9.4.20.v20190813.jar:./libs/jetty-io-9.4.20.v20190813.jar:./libs/jetty-security-9.4.20.v20190813.jar:./libs/jetty-server-9.4.20.v20190813.jar:./libs/jetty-servlet-9.4.20.v20190813.jar:./libs/jetty-servlets-9.4.20.v20190813.jar:./libs/jetty-util-9.4.20.v20190813.jar:./libs/jopt-simple-5.0.4.jar:./libs/kafka_2.12-2.4.0.jar:./libs/kafka_2.12-2.4.0-sources.jar:./libs/kafka-clients-2.4.0.jar:./libs/kafka-log4j-appender-2.4.0.jar:./libs/kafka-streams-2.4.0.jar:./libs/kafka-streams-examples-2.4.0.jar:./libs/kafka-streams-scala_2.12-2.4.0.jar:./libs/kafka-streams-test-utils-2.4.0.jar:./libs/kafka-tools-2.4.0.jar:./libs/log4j-1.2.17.jar:./libs/lz4-java-1.6.0.jar:./libs/maven-artifact-3.6.1.jar:./libs/metrics-core-2.2.0.jar:./libs/netty-buffer-4.1.42.Final.jar:./libs/netty-codec-4.1.42.Final.jar:./libs/netty-common-4.1.42.Final.jar:./libs/netty-handler-4.1.42.Final.jar:./libs/netty-resolver-4.1.42.Final.jar:./libs/netty-transport-4.1.42.Final.jar:./libs/netty-transport-native-epoll-4.1.42.Final.jar:./libs/netty-transport-native-unix-common-4.1.42.Final.jar:./libs/osgi-resource-locator-1.0.1.jar:./libs/paranamer-2.8.jar:./libs/plexus-utils-3.2.0.jar:./libs/reflections-0.9.11.jar:./libs/rocksdbjni-5.18.3.jar:./libs/scala-collection-compat_2.12-2.1.2.jar:./libs/scala-java8-compat_2.12-0.9.0.jar:./libs/scala-library-2.12.10.jar:./libs/scala-logging_2.12-3.9.2.jar:./libs/scala-reflect-2.12.10.jar:./libs/slf4j-api-1.7.28.jar:./libs/slf4j-log4j12-1.7.28.jar:./libs/snappy-java-1.1.7.3.jar:./libs/validation-api-2.0.1.Final.jar:./libs/zookeeper-3.5.6.jar:./libs/zookeeper-jute-3.5.6.jar:./libs/zstd-jni-1.4.3-1.jar" ]
CMD ["kafka.admin.ConfigCommand"]

FROM oracle/graalvm-ce:19.0.2@sha256:684ba0e822eb2f569ffef96abb315f5b66550c4e7d5d38ad6570b72f0ce06c35 as native-build
RUN gu install native-image

RUN yum -y install snappy libzstd lz4 && yum clean all

ARG classpath=./libs/kafka_2.12-2.2.1.jar:./libs/kafka-clients-2.2.1.jar:./libs/scala-library-2.12.8.jar:./libs/scala-logging_2.12-3.9.0.jar:./libs/slf4j-api-1.7.25.jar:./libs/slf4j-nop-1.7.25.jar:./libs/jopt-simple-5.0.4.jar:./libs/zookeeper-3.4.13.jar:./libs/metrics-core-2.2.0.jar:./libs/jackson-core-2.9.8.jar:./libs/jackson-databind-2.9.8.jar:./libs/jackson-annotations-2.9.8.jar:./libs/zkclient-0.11.jar:./libs/log4j-1.2.17.jar:./libs/lz4-java-1.5.0.jar:./libs/quarkus-kafka-client-0.16.1.jar

WORKDIR /opt/kafka

COPY --from=dist /opt/kafka .

# Failed to verify that a reflection config file makes any difference though
COPY reflection.json .

COPY --from=maven-jars /quarkus-kafka-client-0.16.1.jar ./libs/quarkus-kafka-client-0.16.1.jar
COPY --from=jopt-simple-jar /jopt-simple-5.0.4.jar ./libs/jopt-simple-5.0.4.jar

RUN native-image \
  --no-server \
  #--static \
  --report-unsupported-elements-at-runtime \
  -H:+ReportExceptionStackTraces \
  --no-fallback \
  -H:IncludeResourceBundles=joptsimple.HelpFormatterMessages \
  -H:IncludeResourceBundles=joptsimple.ExceptionMessages \
  -H:ReflectionConfigurationFiles=reflection.json \
  -cp ${classpath} \
  -H:Name=kafka-configs \
  kafka.admin.ConfigCommand

RUN native-image \
  --no-server \
  #--static \
  --report-unsupported-elements-at-runtime \
  -H:+ReportExceptionStackTraces \
  --no-fallback \
  -H:IncludeResourceBundles=joptsimple.HelpFormatterMessages \
  -H:IncludeResourceBundles=joptsimple.ExceptionMessages \
  -H:ReflectionConfigurationFiles=reflection.json \
  -cp ${classpath} \
  -H:Name=kafka-topics \
  kafka.admin.TopicCommand

RUN native-image \
  --no-server \
  #--static \
  --report-unsupported-elements-at-runtime \
  -H:+ReportExceptionStackTraces \
  --no-fallback \
  -H:IncludeResourceBundles=joptsimple.HelpFormatterMessages \
  -H:IncludeResourceBundles=joptsimple.ExceptionMessages \
  -H:ReflectionConfigurationFiles=reflection.json \
  -cp ${classpath} \
  -H:Name=kafka-consumer-groups \
  kafka.admin.ConsumerGroupCommand

# TODO kafka-leader-election

RUN ./kafka-configs --help 2>&1 | grep '^--'
RUN ./kafka-topics --help 2>&1 | grep '^--'
#RUN ./kafka-consumer-groups --help 2>&1 | grep '^--'

# same base as graalvm-ce
FROM oraclelinux:7-slim@sha256:0de5413fba176b3b03a7aaa3c9bd1583371ad88314b29927327ff97d5a94e7f7

RUN yum -y install snappy libzstd lz4 && yum clean all

COPY --from=native-build /opt/kafka/kafka-configs /usr/local/bin/kafka-configs
COPY --from=native-build /opt/kafka/kafka-topics /usr/local/bin/kafka-topics
COPY --from=native-build /opt/kafka/kafka-consumer-groups /usr/local/bin/kafka-consumer-groups

# Compatibility with scripts written for the solsson/kafka image
RUN mkdir -p /opt/kafka/bin && \
  cd /opt/kafka && \
  for bin in /usr/local/bin/*; do ln -s $bin ./bin/$(basename $bin).sh; done
WORKDIR /opt/kafka

ENTRYPOINT [ "kafka-configs" ]
